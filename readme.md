
# DAS激光发送/采样器

## 核心器件选型
1. MCU 沁恒RISCV架构MCU CH32V208
2. ADC 暂用CH32V208集成14bit ADC
3. 运算放大器 OP07C

## 原理简介
本设备的主要功能为对通信光纤中的反射光强进行采样，将采样信息传输到上位机进行分析。最终产品成本限制较大，故采用低成本国产MCU与较低采样率的内置ADC进行采样。待采样介质光速达到$10^8$量级，为达到目标的空间分辨率(10m)采样速率需要达到100ns量级，即10MSa/s。本设备采用多轮错位采样的方式进行过采样进而达到预设的目标采样率。

## 电路原理图
TBD
## 代码说明

### 定时器：
1. 主计时器-TIM2-通用定时器
   **配置为循环计数模式，开启中断**
   
   中断服务：
   1. 启动激光发射计时器
   2. 启动ADC
   3. 启动DMA

2. 激光发射计时器-TIM1-高级定时器
   **配置为PWM1模式，开启中断**
   1. 生成高频低占空比PWM脉冲波形驱动激光管

### ADC
1. 主ADC-ADC1
    **配置为独立模式，采样时间1.5采样周期**
    配置为连续采样，启用DMA发送
2. 从ADC-ADC2
    **配置为快速交替模式，开启后采样率翻倍**
   TBD-CH32V208无ADC2 尚未启用

### DMA
1. DMA1_Channel1-ADCdma
    **配置为Normal模式，单次搬运指定长度数据**

    中断服务：
    1. 关闭激光发射计时器(TIM1)
    2. 关闭ADC

### USB
配置USBFS设备，模拟为CDC串口设备，向上位机通信，本项目条件下测试发送速率大于每秒1.5MBytes

### 主循环：
   1. ADC数据处理校准，协议包拼接
   2. 数据发送
   
### 主要功能时钟树
``` bash
sysclock(~~144M~~/96M/48M)
|
|-- /1 --AHB
        |-- /1 --APB1
        |         |--TIM2
        |-- /1 --APB2
                  |-- /8 --ADC1|ADC2
                  |--TIM1
```
注1：USBFS使用时，系统频率不可低于48M
注2：ADC频率最高为14MHz

## 通信协议数据格式说明
1. 数据接口：USB2.0全速 模拟CDC设备 实验条件下速率 > 1.5MBytes
2. 数据发送间隔：20ms
3. 数据组成与大小：控制信息3Byte + 连续数据
注：数据以 uint_16 存储，先发送数据高半位